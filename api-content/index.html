{"posts":[{"title":"Hmaster 启动过程","content":"1. 调用链 HMasterCommandLine | | - run local | ----- - startMaster -| | | |- new MiniZooKeeperCluster.startup //embedded zookeeper cluster | | |- createDir //创建 zk 数据目录 | | |- zks = new ZooKeeperServer | | |- new NIOServerCnxn.Factory(clientPort).startup //启动服务 | | | | | | | |- zks.startdata | | | | | | | | | |- new ZKDatabase | | | | |- loadData // Restore sessions and data | | | | | | | - zks.startup | | | | | | | |- startSessionTracker | | | |- setupRequestProcessors | | | | | | | |- new FinalRequestProcessor | | | |- new SyncRequestProcessor.start | | | |- new PrepRequestProcessor.start | | | |- registerJMX //注册JMX mbean | | | | | - waitForServerUp // echo &quot;stat&quot; to assert zk liveless | | | | | - new LocalHBaseCluster().startup //启动包括 Hmaster + RS 的服务 | | | |- masterClass = org.apache.hadoop.hbase.master.HMasterCommandLine$LocalHMaster | |- addMaster() | | |- createMasterThread() | | | |- HMaster.init() | | | | |- HregionServer.init() | | | | | |- UserProvider.instantiate(conf) // 初始化 userprovider | | | | | |- FSUtils.setupShortCircuitRead(this.conf) // short circuit read setup | | | | | |- createRpcServices() | | | | | | | - MasterRpcServices.init() -&gt;RSRpcServices.init() | | | | | | | | - rpcServer = new RpcServer() | | | | | | | | | - rpcSchedulerFactory.create() | | | | | | | | | | - callExecutor //初始化读写executor | | | | | | | | | | - priorityExecutor //初始化priorityExecutor | | | | | | | | | | - replicationExecutor //初始化replicationExecutor | | | | | |- new ZooKeeperWatcher() //初始化zk连接和watcher，并create相关的znode | | | | | | | - createBaseZNodes() | | | | | |- TableLockManager.createTableLockManager // 基于zk的table-level lock | | | | | |- new MasterAddressTracker.start() // znode watcher to track master address ( /hbase/master ) | | | | | |- new ClusterStatusTracker.start() // znode watcher to track cluster status ( /hbase/running ) | | | | | |- new ConfigurationManager() // reload configuration on the fly | | | | | |- rpcServices.start() // start rpc threads | | | | | | |- rpcServices.start() // start rpc threads | | | | | | | |- responder.start() | | | | | | | |- listener.start() | | | | | | | |- scheduler.start() | | | | | | | | | - callExecutor.start | | | | | | | | | - priorityExecutor.start | | | | | | | | | - replicationExecutor.start | | | | | | |- putUpWebUI() | | | | | | |- new LogRoller() | | | | | | |- new ChoreService() | | | | | - new ActiveMasterManager() // Handles everything on master-side related to master election. This is a zk listener | | | | | - startActiveMasterManager() | | | | | | - MasterAddressTracker.setMasterAddress() // create /hbase/backup-masters/XX | | | | | | - Threads.setDaemonThreadRunning() // Start a new thread to try to become the active master | | | | | | |- blockUntilBecomingActiveMaster() // try to become master | | | | | | | |- finishActiveMasterInitialization() | | | | | | | | | - new MasterFileSystem() // class for hmaster to interact with underlying file system | | | | | | | | | - new ServerManager() // manage info about region servers including online/dead servers and processing the startsup,shutdown and deaths of regionservers | | | | | | | | | - setupClusterConnection | | | | | | | | | - initializeZKBasedSystemTrackers // Initialize all ZK based system trackers | | | | | | | | | | - getLoadBalancer | | | | | | | | | | - getRegionNormalizer | | | | | | | | | | - new AssignmentManager | | | | | | | | | | - new SnapshotManager | | | | | | | | | | - new MasterProcedureManagerHost | | | | | | | | | - new MasterCoprocessorHost // master coprocessor class | | | | | | | | | - startServiceThreads // start several master executor service | | | | | | | | | | - MASTER_OPEN_REGION | | | | | | | | | | - MASTER_CLOSE_REGION | | | | | | | | | | - MASTER_SERVER_OPERATIONS | | | | | | | | | | - MASTER_META_SERVER_OPERATIONS | | | | | | | | | | - M_LOG_REPLAY_OPS | | | | | | | | | | - MASTER_SNAPSHOT_OPERATIONS | | | | | | | | | | - MASTER_TABLE_OPERATIONS | | | | | | | | | | - new LogCleaner chore | | | | | | | | | | - new HFileCleaner chore | | | | | | | | | | - new replicationZKLockCleanerChore chore | | | | | | | | | | - new replicationZKNodeCleanerChore chore | | | | | | | | | - assignMeta // assign meta table | | | | | | | | | - new ClusterStatusChore() | | | | | | | | | - new BalancerChore() | | | | | | | | | - new RegionNormalizerChore() | | | | | | | | | - new CatalogJanitor() | | | | | | | | | - new PeriodicDoMetrics() | | | | | | | | | - new TableNamespaceManager().start | | | | | | | | | - configurationManager.registerObserver(this.balancer) //enable configuration reload on the fly | | | | | | | | | - configurationManager.registerObserver(this.cleanerPool) | | | | | | | | | - configurationManager.registerObserver(this.hfileCleaner) | | | | | | | | | - configurationManager.registerObserver(this.logCleaner) | | | | | | | | | - initQuotaManager | | - RegionServerClass = org.apache.hadoop.hbase.regionserver.HRegionServer | | - addRegionServer () | | |- createRegionServerThread() | | | | |- HregionServer.init() | - waitOnMasterThreads distributed -------- | - HMaster.constructMaster() | | | |- masterClass = org.apache.hadoop.hbase.master.HMaster | | |- HMaster.init() ","link":"https://casperit.github.io/post/hmaster-qi-dong-guo-cheng/"}]}